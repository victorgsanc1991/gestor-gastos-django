{% extends "core/base.html" %}

{% block title %}Análisis Avanzado{% endblock %}

{% block extra_styles %}
<style>
    .filter-form {
        background-color: #f8f9fa; padding: 20px; border: 1px solid #dee2e6;
        border-radius: 8px; margin-bottom: 20px; display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px; align-items: end;
    }
    .filter-form .form-group { display: flex; flex-direction: column; }
    .filter-form label { font-weight: bold; margin-bottom: 5px; font-size: 14px; }
    .filter-form input, .filter-form select { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .filter-form button { padding: 10px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; height: 40px; }
    .category-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 4px; }
    .category-list label { display: block; font-weight: normal; }
    .chart-container { margin-top: 30px; }
</style>
{% endblock %}

{% block content %}
    <h1>Análisis Avanzado</h1>

    <form class="filter-form" method="get" action="{% url 'analisis' %}">
        <div class="form-group">
            <label for="fecha_inicio">Desde:</label>
            <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ valores_filtro.fecha_inicio|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="fecha_fin">Hasta:</label>
            <input type="date" name="fecha_fin" id="fecha_fin" value="{{ valores_filtro.fecha_fin|default:'' }}" required>
        </div>
        <div class="form-group">
            <label for="tipo_movimiento">Tipo de Movimiento:</label>
            <select name="tipo_movimiento" id="tipo_movimiento">
                <option value="gastos" {% if valores_filtro.tipo_movimiento == 'gastos' %}selected{% endif %}>Solo Gastos</option>
                <option value="ingresos" {% if valores_filtro.tipo_movimiento == 'ingresos' %}selected{% endif %}>Solo Ingresos</option>
                <option value="ambos" {% if valores_filtro.tipo_movimiento == 'ambos' %}selected{% endif %}>Ambos</option>
            </select>
        </div>
        <div class="form-group">
            <label for="agrupacion">Agrupar por:</label>
            <select name="agrupacion" id="agrupacion">
                <option value="mes" {% if valores_filtro.agrupacion == 'mes' %}selected{% endif %}>Mes</option>
                <option value="semana" {% if valores_filtro.agrupacion == 'semana' %}selected{% endif %}>Semana</option>
                <option value="dia" {% if valores_filtro.agrupacion == 'dia' %}selected{% endif %}>Día</option>
            </select>
        </div>
        <div class="form-group" style="grid-column: span 2;">
            <label>Categorías (opcional, si no se marca ninguna se muestra el total):</label>
            <div class="category-list">
                {% for cat in categorias_disponibles %}
                <label>
                    <input type="checkbox" name="categorias" value="{{ cat.id }}" {% if cat.id|stringformat:"s" in valores_filtro.categorias %}checked{% endif %}> {{ cat.nombre }}
                </label>
                {% endfor %}
            </div>
        </div>
        <div class="form-group">
            <button type="submit">Generar Análisis</button>
        </div>
    </form>

    <div id="resultados-analisis">
        {% if chart_data %}
            <div class="chart-container">
                <canvas id="analisisChart"></canvas>
            </div>
        {% elif valores_filtro.fecha_inicio and valores_filtro.fecha_fin %}
             <p>No se encontraron datos para los filtros seleccionados.</p>
        {% else %}
            <p>Selecciona un rango de fechas y haz clic en "Generar Análisis" para ver los resultados.</p>
        {% endif %}
    </div>

{% endblock %}

{% block extra_scripts %}
    {% if chart_data %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const ctx = document.getElementById('analisisChart').getContext('2d');
            
            // Obtenemos los datos completos del contexto de Django
            const chartData = JSON.parse('{{ chart_data|escapejs }}');
            
            // === SCRIPT ACTUALIZADO PARA MÚLTIPLES LÍNEAS ===
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    // 'datasets' ahora es un array de objetos que viene directamente del backend
                    datasets: chartData.datasets 
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            // La leyenda solo se muestra si hay más de una línea de datos
                            display: chartData.datasets.length > 1
                        }
                    }
                }
            });
        });
    </script>
    {% endif %}
{% endblock %}