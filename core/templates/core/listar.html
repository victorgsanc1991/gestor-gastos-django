{% extends "core/base.html" %}

{% block title %}Listado de Transacciones{% endblock %}

{% block extra_styles %}
<style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f8f9fa; }
    tr:hover { background-color: #f1f1f1; }
    .gasto { color: #d9534f; font-weight: bold; }
    .ingreso { color: #5cb85c; font-weight: bold; }
    .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; }
    .btn-delete { background-color: #dc3545; }
    .btn-delete-multiple { background-color: #c82333; font-weight: bold; margin-bottom: 10px; }
</style>
{% endblock %}

{% block content %}
    <h1>Listado de Movimientos</h1>
    <form action="{% url 'eliminar_multiples' %}" method="post" id="multiple-delete-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-delete-multiple" onclick="return confirm('¿Estás seguro de que quieres eliminar TODAS las transacciones seleccionadas?');">
            Eliminar Seleccionadas
        </button>
        <table>
            <thead><tr><th><input type="checkbox" id="select-all"></th><th>Fecha</th><th>Concepto</th><th>Importe</th><th style="width: 25%;">Categoría</th><th>Acciones</th></tr></thead>
            <tbody>
                {% for transaccion in transacciones %}
                    <tr>
                        <td><input type="checkbox" name="transaccion_ids" value="{{ transaccion.id }}" class="transaction-checkbox"></td>
                        <td>{{ transaccion.fecha_operacion|date:"d/m/Y" }}</td>
                        <td>{{ transaccion.concepto_original }}</td>
                        {% if transaccion.importe < 0 %}<td class="gasto">{{ transaccion.importe }} €</td>{% else %}<td class="ingreso">+{{ transaccion.importe }} €</td>{% endif %}
                        <td>
                            <form action="{% url 'actualizar_categoria' %}" method="post" style="margin: 0;">
                                {% csrf_token %}
                                <input type="hidden" name="transaccion_id" value="{{ transaccion.id }}">
                                <select name="categoria_id" onchange="this.form.submit()" style="width: 100%; padding: 5px; border-radius: 4px;">
                                    <option value="" {% if not transaccion.categoria %}selected{% endif %}>--- Sin categoría ---</option>
                                    {% for cat in categorias %}<option value="{{ cat.id }}" {% if transaccion.categoria.id == cat.id %}selected{% endif %}>{{ cat.nombre }}</option>{% endfor %}
                                </select>
                            </form>
                        </td>
                        <td>
                            <form action="{% url 'eliminar_transaccion' transaccion.id %}" method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-delete" onclick="return confirm('¿Estás seguro de que quieres eliminar esta transacción?');">Eliminar</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="6" style="text-align: center; padding: 20px;">No hay transacciones para mostrar.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
{% endblock %}

{% block extra_scripts %}
<script>
    document.getElementById('select-all').addEventListener('change', function(e) {
        document.querySelectorAll('.transaction-checkbox').forEach(function(checkbox) {
            checkbox.checked = e.target.checked;
        });
    });
</script>
{% endblock %}