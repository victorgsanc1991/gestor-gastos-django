{% extends "core/base.html" %}

{% block title %}Listado de Transacciones{% endblock %}

{% block extra_styles %}
<style>
    /* Estilos generales que ya tenías */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f8f9fa; }
    tr:hover { background-color: #f1f1f1; }
    .gasto { color: #d9534f; font-weight: bold; }
    .ingreso { color: #5cb85c; font-weight: bold; }
    .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; }
    .btn-delete { background-color: #dc3545; }
    .btn-delete-multiple { background-color: #c82333; font-weight: bold; margin-bottom: 10px; }

    /* Estilos para el formulario de filtros */
    .filter-form {
        background-color: #f8f9fa;
        padding: 20px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 20px;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    .filter-form .form-group { display: flex; flex-direction: column; }
    .filter-form label { font-weight: bold; margin-bottom: 5px; font-size: 14px; color: #495057; }
    .filter-form input, .filter-form select { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
    .filter-form button { padding: 10px; font-size: 16px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; height: 40px; }
</style>
{% endblock %}

{% block content %}
    <h1>Listado de Movimientos</h1>

    <!-- FORMULARIO DE FILTROS -->
    <form class="filter-form" method="get" action="{% url 'listar' %}">
        <div class="form-group">
            <label for="fecha_inicio">Desde:</label>
            <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ valores_filtro.fecha_inicio|default:'' }}">
        </div>
        <div class="form-group">
            <label for="fecha_fin">Hasta:</label>
            <input type="date" name="fecha_fin" id="fecha_fin" value="{{ valores_filtro.fecha_fin|default:'' }}">
        </div>
        <div class="form-group">
            <label for="concepto">Concepto contiene:</label>
            <input type="text" name="concepto" id="concepto" placeholder="Ej: Mercadona, Nómina..." value="{{ valores_filtro.concepto|default:'' }}">
        </div>
        <div class="form-group">
            <label for="categoria">Categoría:</label>
            <select name="categoria" id="categoria">
                <option value="">Todas</option>
                <option value="0" {% if valores_filtro.categoria == '0' %}selected{% endif %}>--- Sin Categoría ---</option>
                {% for cat in categorias %}
                    <option value="{{ cat.id }}" {% if valores_filtro.categoria == cat.id|stringformat:"s" %}selected{% endif %}>{{ cat.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <button type="submit">Filtrar</button>
        </div>
    </form>

    <!-- === CAMBIO ESTRUCTURAL IMPORTANTE === -->
    <!-- El formulario de borrado múltiple ahora solo contiene el botón -->
    <form action="{% url 'eliminar_multiples' %}" method="post" id="multiple-delete-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-delete-multiple" onclick="return confirm('¿Estás seguro de que quieres eliminar TODAS las transacciones seleccionadas?');">
            Eliminar Seleccionadas
        </button>
    </form>

    <!-- La tabla ahora está fuera del formulario principal -->
    <table>
        <thead>
            <tr>
                <!-- El checkbox de la cabecera ahora solo tiene una función visual con JavaScript -->
                <th><input type="checkbox" id="select-all"></th>
                <th>Fecha</th>
                <th>Concepto</th>
                <th>Importe</th>
                <th style="width: 25%;">Categoría</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for transaccion in transacciones %}
                <tr>
                    <td>
                        <!-- El atributo 'form' vincula este checkbox al formulario de borrado por su 'id' -->
                        <input type="checkbox" name="transaccion_ids" value="{{ transaccion.id }}" class="transaction-checkbox" form="multiple-delete-form">
                    </td>
                    <td>{{ transaccion.fecha_operacion|date:"d/m/Y" }}</td>
                    <td>{{ transaccion.concepto_original }}</td>
                    {% if transaccion.importe < 0 %}<td class="gasto">{{ transaccion.importe }} €</td>{% else %}<td class="ingreso">+{{ transaccion.importe }} €</td>{% endif %}
                    <td>
                        <!-- Este formulario es independiente y no causa problemas de anidamiento -->
                        <form action="{% url 'actualizar_categoria' %}" method="post" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="transaccion_id" value="{{ transaccion.id }}">
                            <select name="categoria_id" onchange="this.form.submit()" style="width: 100%; padding: 5px; border-radius: 4px;">
                                <option value="" {% if not transaccion.categoria %}selected{% endif %}>--- Sin categoría ---</option>
                                {% for cat in categorias %}<option value="{{ cat.id }}" {% if transaccion.categoria.id == cat.id %}selected{% endif %}>{{ cat.nombre }}</option>{% endfor %}
                            </select>
                        </form>
                    </td>
                    <td>
                        <!-- Este formulario también es independiente -->
                        <form action="{% url 'eliminar_transaccion' transaccion.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-delete" onclick="return confirm('¿Estás seguro de que quieres eliminar esta transacción?');">Eliminar</button>
                        </form>
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="6" style="text-align: center; padding: 20px;">No se encontraron transacciones con los filtros aplicados.</td></tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock %}

{% block extra_scripts %}
<script>
    // Este script ahora vincula el checkbox "select-all" con los checkboxes del formulario
    document.getElementById('select-all').addEventListener('change', function(e) {
        document.querySelectorAll('.transaction-checkbox').forEach(function(checkbox) {
            checkbox.checked = e.target.checked;
        });
    });
</script>
{% endblock %}