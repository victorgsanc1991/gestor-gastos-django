<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Transacciones</title>
    <style>
        body { font-family: sans-serif; max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #f4f7f6; }
        nav { display: flex; justify-content: center; gap: 20px; padding: 10px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        nav a { text-decoration: none; color: #007bff; font-weight: bold; font-size: 16px; padding: 8px 12px; border-radius: 5px; transition: background-color 0.2s; }
        nav a:hover { background-color: #e9ecef; }
        h1 { color: #343a40; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; }
        tr:hover { background-color: #f1f1f1; }
        .gasto { color: #d9534f; font-weight: bold; }
        .ingreso { color: #5cb85c; font-weight: bold; }
        .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete-multiple { background-color: #c82333; font-weight: bold; margin-bottom: 10px; }
        .messages { padding: 15px; margin-bottom: 20px; border-radius: 5px; }
        .messages.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .messages.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .messages.warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    </style>
</head>
<body>

    <nav>
        <a href="{% url 'subir' %}">Subir Archivo</a>
        <a href="{% url 'listar' %}">Ver Transacciones</a>
        <a href="{% url 'dashboard' %}">Dashboard</a>
        {% if user.is_authenticated and user.is_staff %}
            <a href="/admin" target="_blank" style="color: #6c757d;">Admin</a>
        {% endif %}
    </nav>
    
    {% if messages %}
        {% for message in messages %}
            <div class="messages {{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <h1>Listado de Movimientos</h1>

    <form action="{% url 'eliminar_multiples' %}" method="post" id="multiple-delete-form">
        {% csrf_token %}
        <button type="submit" class="btn btn-delete-multiple" 
                onclick="return confirm('¿Estás seguro de que quieres eliminar TODAS las transacciones seleccionadas?');">
            Eliminar Seleccionadas
        </button>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Fecha</th>
                    <th>Concepto</th>
                    <th>Importe</th>
                    <th style="width: 25%;">Categoría</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for transaccion in transacciones %}
                    <tr>
                        <td><input type="checkbox" name="transaccion_ids" value="{{ transaccion.id }}" class="transaction-checkbox"></td>
                        <td>{{ transaccion.fecha_operacion|date:"d/m/Y" }}</td>
                        <td>{{ transaccion.concepto_original }}</td>
                        {% if transaccion.importe < 0 %}<td class="gasto">{{ transaccion.importe }} €</td>{% else %}<td class="ingreso">+{{ transaccion.importe }} €</td>{% endif %}
                        <td>
                            <form action="{% url 'actualizar_categoria' %}" method="post" style="margin: 0;">
                                {% csrf_token %}
                                <input type="hidden" name="transaccion_id" value="{{ transaccion.id }}">
                                <select name="categoria_id" onchange="this.form.submit()" style="width: 100%; padding: 5px; border-radius: 4px;">
                                    <option value="" {% if not transaccion.categoria %}selected{% endif %}>--- Sin categoría ---</option>
                                    {% for cat in categorias %}<option value="{{ cat.id }}" {% if transaccion.categoria.id == cat.id %}selected{% endif %}>{{ cat.nombre }}</option>{% endfor %}
                                </select>
                            </form>
                        </td>
                        <td>
                            <form action="{% url 'eliminar_transaccion' transaccion.id %}" method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-delete" onclick="return confirm('¿Estás seguro de que quieres eliminar esta transacción?');">Eliminar</button>
                            </form>
                        </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="6" style="text-align: center; padding: 20px;">No hay transacciones para mostrar.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </form>
    
    <script>
        document.getElementById('select-all').addEventListener('change', function(e) {
            document.querySelectorAll('.transaction-checkbox').forEach(function(checkbox) {
                checkbox.checked = e.target.checked;
            });
        });
    </script>

</body>
</html>